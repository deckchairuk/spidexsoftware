THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){function e(t){if(!1!==t.visible){if(t instanceof THREE.Light)O.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Points){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===G.intersectsObject(t))return;r(t)}else if(t instanceof THREE.Sprite){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===G.intersectsSprite(t))return;r(t)}for(var i=t.children,n=0,o=i.length;n<o;n++)e(i[n])}}function r(e){(p=i()).id=e.id,p.object=e,C.setFromMatrixPosition(e.matrixWorld),C.applyMatrix4(A),p.z=C.z,p.renderOrder=e.renderOrder,O.objects.push(p)}function t(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&((y=s()).id=r.id,y.x=e.x*i,y.y=e.y*i,y.z=e.z,y.renderOrder=r.renderOrder,y.object=r,y.rotation=r.rotation,y.scale.x=r.scale.x*Math.abs(y.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),y.scale.y=r.scale.y*Math.abs(y.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),y.material=r.material,O.elements.push(y))}function i(){if(E===H){var e=new THREE.RenderableObject;return T.push(e),H++,E++,e}return T[E++]}function n(){if(f===w){var e=new THREE.RenderableVertex;return g.push(e),w++,f++,e}return g[f++]}function o(){if(d===M){var e=new THREE.RenderableFace;return S.push(e),M++,d++,e}return S[d++]}function a(){if(m===z){var e=new THREE.RenderableLine;return b.push(e),z++,m++,e}return b[m++]}function s(){if(x===j){var e=new THREE.RenderableSprite;return V.push(e),j++,x++,e}return V[x++]}function l(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function c(e,r){var t=0,i=1,n=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return n>=0&&o>=0&&a>=0&&s>=0||!(n<0&&o<0||a<0&&s<0)&&(n<0?t=Math.max(t,n/(n-o)):o<0&&(i=Math.min(i,n/(n-o))),a<0?t=Math.max(t,a/(a-s)):s<0&&(i=Math.min(i,a/(a-s))),!(i<t)&&(e.lerp(r,t),r.lerp(e,1-i),!0))}var p,E,u,f,h,d,v,m,y,x,R,T=[],H=0,g=[],w=0,S=[],M=0,b=[],z=0,V=[],j=0,O={objects:[],lights:[],elements:[]},C=new THREE.Vector3,L=new THREE.Vector4,k=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),B=new THREE.Box3,N=new Array(3),W=new THREE.Matrix4,A=new THREE.Matrix4,F=new THREE.Matrix4,P=new THREE.Matrix3,G=new THREE.Frustum,D=new THREE.Vector4,U=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var I=new function(){function e(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(R),i.copy(t).applyMatrix4(A);var n=1/i.w;i.x*=n,i.y*=n,i.z*=n,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function r(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(N[0]=e.positionScreen,N[1]=r.positionScreen,N[2]=t.positionScreen,k.intersectsBox(B.setFromPoints(N)))}function t(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}var i=[],s=[],l=[],p=null,E=null,f=new THREE.Matrix3;return{setObject:function(e){E=(p=e).material,f.getNormalMatrix(p.matrixWorld),i.length=0,s.length=0,l.length=0},projectVertex:e,checkTriangleVisibility:r,checkBackfaceCulling:t,pushVertex:function(r,t,i){(u=n()).position.set(r,t,i),e(u)},pushNormal:function(e,r,t){i.push(e,r,t)},pushColor:function(e,r,t){s.push(e,r,t)},pushUv:function(e,r){l.push(e,r)},pushLine:function(e,r){var t=g[e],i=g[r];t.positionScreen.copy(t.position).applyMatrix4(F),i.positionScreen.copy(i.position).applyMatrix4(F),!0===c(t.positionScreen,i.positionScreen)&&(t.positionScreen.multiplyScalar(1/t.positionScreen.w),i.positionScreen.multiplyScalar(1/i.positionScreen.w),(v=a()).id=p.id,v.v1.copy(t),v.v2.copy(i),v.z=Math.max(t.positionScreen.z,i.positionScreen.z),v.renderOrder=p.renderOrder,v.material=p.material,p.material.vertexColors===THREE.VertexColors&&(v.vertexColors[0].fromArray(s,3*e),v.vertexColors[1].fromArray(s,3*r)),O.elements.push(v))},pushTriangle:function(e,n,a){var s=g[e],c=g[n],u=g[a];if(!1!==r(s,c,u)&&(E.side===THREE.DoubleSide||!0===t(s,c,u))){(h=o()).id=p.id,h.v1.copy(s),h.v2.copy(c),h.v3.copy(u),h.z=(s.positionScreen.z+c.positionScreen.z+u.positionScreen.z)/3,h.renderOrder=p.renderOrder,h.normalModel.fromArray(i,3*e),h.normalModel.applyMatrix3(f).normalize();for(var d=0;d<3;d++){var v=h.vertexNormalsModel[d];v.fromArray(i,3*arguments[d]),v.applyMatrix3(f).normalize(),h.uvs[d].fromArray(l,2*arguments[d])}h.vertexNormalsLength=3,h.material=p.material,O.elements.push(h)}}}};this.projectScene=function(r,i,s,p){d=0,m=0,x=0,O.elements.length=0,!0===r.autoUpdate&&r.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),W.copy(i.matrixWorldInverse),A.multiplyMatrices(i.projectionMatrix,W),G.setFromMatrix(A),E=0,O.objects.length=0,O.lights.length=0,e(r),!0===s&&O.objects.sort(l);for(var u=O.objects,y=0,T=u.length;y<T;y++){var H=u[y].object,w=H.geometry;if(I.setObject(H),R=H.matrixWorld,f=0,H instanceof THREE.Mesh){if(w instanceof THREE.BufferGeometry){var S=w.attributes,M=w.groups;if(void 0===S.position)continue;for(var b=0,z=(Te=S.position.array).length;b<z;b+=3)I.pushVertex(Te[b],Te[b+1],Te[b+2]);if(void 0!==S.normal)for(var V=S.normal.array,b=0,z=V.length;b<z;b+=3)I.pushNormal(V[b],V[b+1],V[b+2]);if(void 0!==S.uv)for(var j=S.uv.array,b=0,z=j.length;b<z;b+=2)I.pushUv(j[b],j[b+1]);if(null!==w.index){var k=w.index.array;if(M.length>0)for(var B=0;B<M.length;B++)for(var N=M[B],b=N.start,z=N.start+N.count;b<z;b+=3)I.pushTriangle(k[b],k[b+1],k[b+2]);else for(var b=0,z=k.length;b<z;b+=3)I.pushTriangle(k[b],k[b+1],k[b+2])}else for(var b=0,z=Te.length/3;b<z;b+=3)I.pushTriangle(b,b+1,b+2)}else if(w instanceof THREE.Geometry){var q=w.vertices,J=w.faces,K=w.faceVertexUvs[0];P.getNormalMatrix(R);for(var Q=H.material,X=Array.isArray(Q),Y=0,Z=q.length;Y<Z;Y++){Re=q[Y];if(C.copy(Re),!0===Q.morphTargets)for(var $=w.morphTargets,_=H.morphTargetInfluences,ee=0,re=$.length;ee<re;ee++){var te=_[ee];if(0!==te){var ie=$[ee].vertices[Y];C.x+=(ie.x-Re.x)*te,C.y+=(ie.y-Re.y)*te,C.z+=(ie.z-Re.z)*te}}I.pushVertex(C.x,C.y,C.z)}for(var ne=0,oe=J.length;ne<oe;ne++){var ae=J[ne];if(void 0!==(Q=!0===X?H.material[ae.materialIndex]:H.material)){var se=Q.side,le=g[ae.a],ce=g[ae.b],pe=g[ae.c];if(!1!==I.checkTriangleVisibility(le,ce,pe)){var Ee=I.checkBackfaceCulling(le,ce,pe);if(se!==THREE.DoubleSide){if(se===THREE.FrontSide&&!1===Ee)continue;if(se===THREE.BackSide&&!0===Ee)continue}(h=o()).id=H.id,h.v1.copy(le),h.v2.copy(ce),h.v3.copy(pe),h.normalModel.copy(ae.normal),!1!==Ee||se!==THREE.BackSide&&se!==THREE.DoubleSide||h.normalModel.negate(),h.normalModel.applyMatrix3(P).normalize();for(var ue=ae.vertexNormals,fe=0,he=Math.min(ue.length,3);fe<he;fe++){var de=h.vertexNormalsModel[fe];de.copy(ue[fe]),!1!==Ee||se!==THREE.BackSide&&se!==THREE.DoubleSide||de.negate(),de.applyMatrix3(P).normalize()}h.vertexNormalsLength=ue.length;var ve=K[ne];if(void 0!==ve)for(var me=0;me<3;me++)h.uvs[me].copy(ve[me]);h.color=ae.color,h.material=Q,h.z=(le.positionScreen.z+ce.positionScreen.z+pe.positionScreen.z)/3,h.renderOrder=H.renderOrder,O.elements.push(h)}}}}}else if(H instanceof THREE.Line){if(F.multiplyMatrices(A,R),w instanceof THREE.BufferGeometry){if(void 0!==(S=w.attributes).position){for(var b=0,z=(Te=S.position.array).length;b<z;b+=3)I.pushVertex(Te[b],Te[b+1],Te[b+2]);if(void 0!==S.color)for(var ye=S.color.array,b=0,z=ye.length;b<z;b+=3)I.pushColor(ye[b],ye[b+1],ye[b+2]);if(null!==w.index)for(var b=0,z=(k=w.index.array).length;b<z;b+=2)I.pushLine(k[b],k[b+1]);else for(var xe=H instanceof THREE.LineSegments?2:1,b=0,z=Te.length/3-1;b<z;b+=xe)I.pushLine(b,b+1)}}else if(w instanceof THREE.Geometry){if(0===(q=H.geometry.vertices).length)continue;(le=n()).positionScreen.copy(q[0]).applyMatrix4(F);for(var xe=H instanceof THREE.LineSegments?2:1,Y=1,Z=q.length;Y<Z;Y++)(le=n()).positionScreen.copy(q[Y]).applyMatrix4(F),(Y+1)%xe>0||(ce=g[f-2],D.copy(le.positionScreen),U.copy(ce.positionScreen),!0===c(D,U)&&(D.multiplyScalar(1/D.w),U.multiplyScalar(1/U.w),(v=a()).id=H.id,v.v1.positionScreen.copy(D),v.v2.positionScreen.copy(U),v.z=Math.max(D.z,U.z),v.renderOrder=H.renderOrder,v.material=H.material,H.material.vertexColors===THREE.VertexColors&&(v.vertexColors[0].copy(H.geometry.colors[Y]),v.vertexColors[1].copy(H.geometry.colors[Y-1])),O.elements.push(v)))}}else if(H instanceof THREE.Points){if(F.multiplyMatrices(A,R),w instanceof THREE.Geometry)for(var Y=0,Z=(q=H.geometry.vertices).length;Y<Z;Y++){var Re=q[Y];L.set(Re.x,Re.y,Re.z,1),L.applyMatrix4(F),t(L,H,i)}else if(w instanceof THREE.BufferGeometry&&void 0!==(S=w.attributes).position)for(var Te=S.position.array,b=0,z=Te.length;b<z;b+=3)L.set(Te[b],Te[b+1],Te[b+2],1),L.applyMatrix4(F),t(L,H,i)}else H instanceof THREE.Sprite&&(L.set(R.elements[12],R.elements[13],R.elements[14],1),L.applyMatrix4(A),t(L,H,i))}return!0===p&&O.elements.sort(l),O}};